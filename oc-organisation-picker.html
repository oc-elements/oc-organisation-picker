<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">

<dom-module id="oc-organisation-picker">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-item:hover {
        background: steelblue;
      }
    </style>

    <paper-dropdown-menu id="dropdown" no-label-float verticalAlign="top" horizontalAlign="left" disabled>
      <paper-listbox id="list" class="dropdown-content" selected="[[ _getDefaultOrganisationIndex(organisations, defaultOrganisation) ]]">
        <template is="dom-repeat" items="[[ organisations ]]" as="organisation">
          <paper-item organisation="[[ organisation ]]">
            <paper-icon-button icon="[[ _calculateIcon(organisation, defaultOrganisation) ]]" on-tap="_onSetAsDefault">
            </paper-icon-button>
            <span on-tap="_selectOragnisation">[[organisation.name]]</span>
          </paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <iron-ajax
            auto
            url="[[_getUrl(permission)]]"
            headers='{"Authorization": "Basic cnVkb2xmQG9yZGVyY2xvdWQuY28uemE6cGFzc3dvcmQ=", "X-Ordercloud-Organisation": "e4e3b3785d48e41a71cb4c348ec85cc5"}'
            handle-as="json"
            on-response="_handleResponse">
    </iron-ajax>

    <iron-localstorage id="storage"
        name="oc-organisation-picker-default"
        value="{{defaultOrganisation}}"
        use-raw
    ></iron-localstorage>
  </template>

  <script>

    Polymer({

      is: 'oc-organisation-picker',

      properties: {
        permission: String,
        selectedOrganisation: {
          type: Object,
          notify: true
        }
      },

      ready: function() {
        this.$.dropdown.$.menuButton.ignoreSelect = true;
      },

      _getUrl: function (permission) {
        return 'https://test-api.ordercloud.com/resource/authorization/user/permission/' + permission + '/organisations';
      },

      _handleResponse: function(event) {
        this.organisations =
                event.detail.response.results
                        .sort(function(a,b) {return (a.name > b.name) ? 1 : ((a.name < b.name) ? -1 : 0);} );
        this.$.dropdown.disabled = false;
      },

      _onSetAsDefault: function(event) {
        this.defaultOrganisation = event.model.organisation.id;
      },

      _calculateIcon: function(organisation, defaultOrganisation) {
        return organisation.id == defaultOrganisation ? "star" : "star-border";
      },

      _selectOragnisation: function(event) {
        this.$.dropdown.close();
        this.fire('oc-organisation-selected', event.model.organisation);
        this.selectedOrganisation = event.model.organisation;
      },

      _getDefaultOrganisationIndex(organisations, defaultOrganisation) {
        for(var i = 0; i < organisations.length; i++) {
          if (organisations[i].id == defaultOrganisation) {
            return i;
          }
        }
        return 0;
      }
    });
  </script>
</dom-module>
