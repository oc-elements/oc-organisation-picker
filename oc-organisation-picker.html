<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">

<link rel="import" href="../oc-core-utils/oc-api-consumer-behaviour.html">
<link rel="import" href="../oc-authorization-api/oc-authorization-api.html">

<!--
@demo
-->
<dom-module id="oc-organisation-picker">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-item:hover {
        background: steelblue;
        color: white;
      }
      paper-icon-button {
        min-width: 40px;
      }
    </style>

    <paper-dropdown-menu id="dropdown" no-label-float vertical-align="top" horizontal-align="left" disabled$="[[ !organisations ]]">
      <paper-listbox class="dropdown-content" selected="[[ _getDefaultOrganisationIndex(organisations, defaultOrganisationId) ]]">
        <template is="dom-repeat" items="[[ organisations ]]" as="organisation">
          <paper-item organisation="[[ organisation ]]">
            <paper-icon-button icon="[[ _calculateIcon(organisation, defaultOrganisationId) ]]" on-tap="_selectDefault"></paper-icon-button>
            <span on-tap="_selectOragnisation">[[ organisation.name ]]</span>
          </paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <iron-localstorage id="storage" use-raw
        name="oc-organisation-picker-default"
        value="{{ defaultOrganisationId }}"
    ></iron-localstorage>

    <oc-authorization-api id="authApi"></oc-authorization-api>

  </template>

  <script>
    Polymer({
      is: 'oc-organisation-picker',
      behaviors: [OC.Behaviours.ApiConsumer],

      properties: {
        /**
         * The permissions used to determine the list of organisations.
         */
        permission: {
          type: String,
          observer: '_fetchOrganisations'
        },
        /**
         * The selected organisation
         */
        selectedOrganisation: {
          type: Number,
          notify: true
        },
        /**
         * The default organisation ID
         */
        defaultOrganisationId: {
          type: Number
        }
      },

      ready: function() {
        this.$.dropdown.$.menuButton.ignoreSelect = true;
      },

      _fetchOrganisations: function(a, b) {
        this.$.authApi.getOrganisations(a)
            .then(this._setPropertyResponseResults.bind(this, 'organisations'))
            .catch(console.error);
      },

      _selectDefault: function(event) {
        this.defaultOrganisationId = event.model.organisation.id;
      },

      _calculateIcon: function(organisation, defaultOrganisationId) {
        return organisation.id == defaultOrganisationId ? "star" : "star-border";
      },

      _selectOragnisation: function(event) {
        this.$.dropdown.close();
        this.selectedOrganisation = event.model.organisation;
        this.fire('oc-organisation-selected', event.model.organisation);
      },

      _getDefaultOrganisationIndex(organisations, defaultOrganisationId) {
        for(var i = 0; i < organisations.length; i++) {
          if (organisations[i].id == defaultOrganisationId) {
            return i;
          }
        }
        return 0;
      }

    });
  </script>
</dom-module>
