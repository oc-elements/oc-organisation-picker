<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">

<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../neon-animation/web-animations.html">

<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/communication-icons.html">



<link rel="import" href="../oc-authorization-api/oc-authorization-api.html">
<link rel="import" href="../oc-organisation-api/oc-organisation-api.html">

<dom-module id="oc-organisation-picker">
	<template>
		<style>
			:host {
				--paper-input-container-input: {
					font-size: 14px !important;
					font-weight: 500 !important;
					width: 100% !important;
					display: grid !important;
				};

				--paper-input-container-shared-input-style: {
					color: #fff;
				};

				display: block;

				--paper-input-container-underline: {
					display: none;
				};

				--paper-input-container-underline-focus: {
					display: none;
				};

				--paper-input-container-underline-disabled: {
					display: none;
				};
				background: #3d4b59;
				margin-top:-11px;
				width:100%;
			}
			paper-menu {
				width: 800px;
			}

			paper-dropdown-menu.custom {
				width: calc(100%);

				display: grid !important;
				--iron-input: {
					width:100%;
				};
				--paper-input-container-input: {
					color:#eeeeee;
					width: 100% !important;
					display: grid !important;

				};

			}

			paper-icon-item {
				display: block;
			}

			a {
				text-decoration: none;
			}

			.picker-container {
				margin-left: 8px;
			}

			.add-button a {
				color: #fff;
			}

			paper-listbox {
				color: #fff !important;
				display: contents;
			}

			.star {
				color: #e0992f;
			}

			.start-border {
				color: #e0992f !important;
			}

			.store-icon {
				color: #fff;
				margin-right: 5px;
			}

			/* Following css is for the search filter */

			paper-item {
				padding-left: 0;
			}

			iron-input {
				width: 100%;
			}

			.search-input {

				box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.1), 0 0 0 0 rgba(0, 0, 0, 0.14), 0 0 0 0 rgba(0, 0, 0, 0.12);
				border: none;
				width: 100%;
				height: 40px;
				line-height: 48px;
				margin-bottom: 5px;

			}

			.block-yo {
				display: block; width:100%;
				padding: 0px !important;
				margin: 0px !important;

			}
		</style>

		<!-- Gets the default organisation out of local storage -->
		<iron-localstorage use-raw name="last-active-organisation" value="{{_defaultOrganisationId}}"></iron-localstorage>
		<iron-localstorage use-raw name="last-active-organisation-code" value="{{_defaultOrganisationCode}}"></iron-localstorage>
		<oc-organisation-api id="organisationApi"></oc-organisation-api>
		<div class="picker-container app-menu-item">

			<paper-dropdown-menu id="dropdown" opened$="[[dropDownState]]" no-label-float disabled$="[[ !organisations ]]" invalid$="[[ errorMessage ]]" error-message="[[ errorMessage ]]"
			 on-tap="onPickerClick" class="custom">

				<paper-listbox id="list" slot="dropdown-content" style="height: 250px">
					<paper-item id="search" style="width:calc(90vw)">
						<iron-icon style="margin: 6px 0px 0 -4px;
						background: orange;
						color: #fff;
						font-size: 13px;
						border-radius: 5px;
						padding: 4px 6px;
						position: absolute;
						right: 16px;
						height: 26px;
						float: right;
						top: -1px;" icon="icons:search" on-tap="_onSearch"></iron-icon>
						<iron-input bind-value="{{_searchText}}" class="row">

							<input id="searchtext" class="search-input" on-tap="_stopEventPropagation" on-keydown="_stopEventPropagation" on-keyup="_stopEventPropagation"
							 placeholder="Search..." type="text">
						</iron-input>
					</paper-item>
					<template is="dom-repeat" items="[[ organisations ]]" as="organisation">
						<paper-item role="option" organisation="[[ organisation ]]" on-tap="_onDropdownItemSelect" class="block-yo" style=" ">
							<span style="padding: 0 5px">[[ organisation.name ]]</span>
						</paper-item>
					</template>
				</paper-listbox>
			</paper-dropdown-menu>
		</div>
		<oc-authorization-api id="authApi"></oc-authorization-api>

	</template>
	<script>
		class OcOrganisationPicker extends Ordercloud.ReduxMixin(Polymer.Element) {
			static get is() {
				return 'oc-organisation-picker';
			}

			static get properties() {
				return {
					/**
					 * The default organisation ID
					 */
					_defaultOrganisationId: {
						type: Number,
						observer: '_dispatchSelectedOrganisation'
					},

					dropDownState: {
						type: Boolean,
						value: false,
						notify: true
					},

					// Set a default organisation code
					_defaultOrganisationCode: {
						type: String,
						value: ''
					},
					/**
					 * flag if the user has been signed in
					 */
					_signedIn: {
						type: String,
						statePath: 'identity.token',
						observer: '_loadOrganisations'
					},
					/**
					 * The list of organisations the user can choose from
					 */
					organisations: {
						type: Array,
						value: [],
						notify: true
					},

					_environment: {
						type: String,
						statePath: 'config.environment'
					},

					isLoading: {
						type: Boolean,
						notify: true
					},
					deviceToken: {
						type: String
					},

					page: {
						type: Number,
						value: 1
					},
					pagesize: {
						type: Number,
						value: 20
					},
					defaultSearchTerm: {
						type: String,
						value: ''
					}
				};
			}

			static get observers() {
				return [
					'_setSelectedOrganisation(organisations.*)',
				]
			}

			ready() {
				super.ready();
			}

			onPickerClick() {
				// Exececute at the end of the call stack after dom has rendered
				setTimeout(() => {
					this.$.dropdown.$.menuButton.$.dropdown.querySelector(".dropdown-content").scrollTop = 0
				}, 1000);
			}

			/* Stop events for dropdown except for arrow up and down. This will make it possible
			* for the user the click on the search input without closing the dropdown */
			_stopEventPropagation(e) {
				//check for enter
				 if (e.keyCode === 13) {
                    this._propogateSearch();
                }
				else if (e.keyCode !== 40 && e.keyCode !== 38) {
					e.stopPropagation();
				}

			}

			/**
			 * Load the organisations where the current user has the given permission.
			 * @param {String} signedIn
			 */
			_loadOrganisations(signedIn, code) {
				if (signedIn === null) {
					this.organisations = null;
					return;
				}

				if (localStorage.getItem('last-active-organisation-code')){
					this._defaultOrganisationCode = localStorage.getItem('last-active-organisation-code');
				}
				else {
					this._defaultOrganisationCode = '';
				}


				this.$.authApi.getOrganisations(this.page, this.pagesize, this._defaultOrganisationCode)
					.then((request) => {
						this.organisations = request.response.results
							.sort(function (a, b) {
								let nameA = a.name.toUpperCase();
								let nameB = b.name.toUpperCase();

								if (nameA < nameB) return -1;
								if (nameA > nameB) return 1;
								return 0;
							});

						if (request.response.count === 0) {
							this.dispatch('receiveNoOrganisation');
						}
					})
					.catch((error) => {
						Raven.captureException(JSON.stringify(error));
						this.errorMessage = 'Failed to load organisations';
					});
			}

			_propogateSearch(_searchText) {
				if(this._searchText.length >= 1){
					this._onSearch();
					setTimeout(() => {
					this.$.dropdown.$.menuButton.$.dropdown.open();

				}, 400);
				setTimeout(() => {
					this.$.search.focused = true;
					this.$.searchtext.focus();
				}, 500);


				}
			}

			_onSearch() {
				//the organisation list is cleared with only the first item/default organisation being concatenated with the search results
				var orglist = [];
				orglist = this.organisations.splice(0,1);
				this.organisations = [];
				this.$.authApi.getOrganisations(this.page, this.pagesize, this._searchText)
					.then((request) => {
						this.set('organisations', orglist.concat(request.response.results));
						if (request.response.count === 0) {
								this.dispatch('receiveNoOrganisation');
							}
				})
				this.dropDownState = true;
				return;
			}

			_resetSearch() {
				this._searchText = '';
			}

			_setSelectedOrganisation(organisations) {
				if (!organisations.base || organisations.base.length === 0) {
					this.errorMessage = 'No organisations';
					return;
				}
				else if (organisations.base.length >= 1) {
					this.errorMessage = '';
				}
				//old code for selecting the selected organisation
				const selectedIndex = organisations.base.findIndex((organisation) => {
					return organisation.id === Number(this._defaultOrganisationId);
				});

				if (selectedIndex !== -1) {
					this.$.list.selectIndex(selectedIndex > 0 ? selectedIndex + 1 : 1);
				}
				else {
					// This code assumes that there will always atleast be one organisation.
					this.$.list.selectIndex(1);
					this._dispatchSelectedOrganisation(organisations.base[0].id);
					this._defaultOrganisationCode = organisations.base[0].code;
				}
			}

			_onDropdownItemSelect(event) {
				var selectedOrg = event.model.index;
				this._defaultOrganisationCode = event.model.organisation.code;

				//this takes the selected item and moves it to the first item in the organisations array
				this.organisations.unshift(this.organisations.splice(selectedOrg, 1)[0]);
				this._dispatchSelectedOrganisation(event.model.organisation.id);
				this.dispatchEvent(new CustomEvent('change-page', {
					bubbles: true, composed: true, detail: { url: '/' }
				}));
				this._searchText = ""; // Dropdown width break if search text does not reset
			}

			_dispatchSelectedOrganisation(id) {
				if (!id) return;
				this._defaultOrganisationId = id;
				this.isLoading = true;
				Promise.all([
					this.dispatch('fetchClientIdIfNeeded', id),
					this.dispatch('fetchOrganisationIfNeeded', id),
					this.dispatch('invalidateAccounts')
				])
					.then(() => this.dispatch('fetchAccountsIfNeeded', id))
					.catch((error) => {
						console.log("Failed to load accounts", error);
						Raven.captureException(JSON.stringify(error));
					});
				this.isLoading = false;

			}
		}

		window.customElements.define(OcOrganisationPicker.is, OcOrganisationPicker);
	</script>
</dom-module>
